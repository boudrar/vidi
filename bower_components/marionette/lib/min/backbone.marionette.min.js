Backbone.Marionette=function(e,t,i){var n={};n.version="0.7.0",n.View=e.View.extend({getTemplateSelector:function(){var e;return e=this.options&&this.options.template?this.options.template:this.template,t.isFunction(e)&&(e=e.call(this)),e},close:function(){this.beforeClose&&this.beforeClose(),this.unbindAll(),this.remove(),this.onClose&&this.onClose(),this.trigger("close"),this.unbind()}}),n.ItemView=n.View.extend({constructor:function(){var e=r.call(arguments);n.View.prototype.constructor.apply(this,e),t.bindAll(this,"render"),this.initialEvents()},initialEvents:function(){this.collection&&this.bindTo(this.collection,"reset",this.render,this)},serializeData:function(){var e;return this.model?e=this.model.toJSON():this.collection&&(e={items:this.collection.toJSON()}),e},render:function(){var e=this,t=i.Deferred(),r=this.getTemplateSelector(),o=this.serializeData();return this.beforeRender&&this.beforeRender(),this.trigger("item:before:render",e),i.when(o).then(function(o){var s=n.Renderer.render(r,o);i.when(s).then(function(i){e.$el.html(i),e.onRender&&e.onRender(),e.trigger("item:rendered",e),e.trigger("render",e),t.resolve()})}),t.promise()},close:function(){this.trigger("item:before:close"),n.View.prototype.close.apply(this,arguments),this.trigger("item:closed")}}),n.CollectionView=n.View.extend({constructor:function(){n.View.prototype.constructor.apply(this,arguments),t.bindAll(this,"addItemView","render"),this.initialEvents()},initialEvents:function(){this.collection&&(this.bindTo(this.collection,"add",this.addChildView,this),this.bindTo(this.collection,"remove",this.removeItemView,this),this.bindTo(this.collection,"reset",this.render,this))},addChildView:function(e){var t=this.getItemView();return this.addItemView(e,t)},render:function(){var e=this,t=i.Deferred(),n=[],r=this.getItemView();return this.beforeRender&&this.beforeRender(),this.trigger("collection:before:render",this),this.closeChildren(),this.collection&&this.collection.each(function(t){var i=e.addItemView(t,r);n.push(i)}),t.done(function(){this.onRender&&this.onRender(),this.trigger("collection:rendered",this)}),i.when(n).then(function(){t.resolveWith(e)}),t.promise()},getItemView:function(){var e=this.options.itemView||this.itemView;if(!e){var t=new Error("An `itemView` must be specified");throw t.name="NoItemViewError",t}return e},addItemView:function(e,t){var n=this,r=this.buildItemView(e,t);this.storeChild(r),this.trigger("item:added",r);var o=r.render();return i.when(o).then(function(){n.appendHtml(n,r)}),o},buildItemView:function(e,t){var i=new t({model:e});return i},removeItemView:function(e){var t=this.children[e.cid];t&&(t.close(),delete this.children[e.cid]),this.trigger("item:removed",t)},appendHtml:function(e,t){e.$el.append(t.el)},storeChild:function(e){this.children||(this.children={}),this.children[e.model.cid]=e},close:function(){this.trigger("collection:before:close"),this.closeChildren(),n.View.prototype.close.apply(this,arguments),this.trigger("collection:closed")},closeChildren:function(){this.children&&t.each(this.children,function(e){e.close()})}}),n.CompositeView=n.CollectionView.extend({constructor:function(){n.CollectionView.apply(this,arguments),this.itemView=this.getItemView()},getItemView:function(){return this.itemView||this.constructor},render:function(){var e=this,t=i.Deferred(),n=this.renderModel();return i.when(n).then(function(n){e.$el.html(n),e.trigger("composite:model:rendered"),e.trigger("render");var r=e.renderCollection();i.when(r).then(function(){t.resolve()})}),t.done(function(){e.trigger("composite:rendered")}),t.promise()},renderCollection:function(){var e=n.CollectionView.prototype.render.apply(this,arguments);return e.done(function(){this.trigger("composite:collection:rendered")}),e.promise()},renderModel:function(){var e={};this.model&&(e=this.model.toJSON());var t=this.getTemplateSelector();return n.Renderer.render(t,e)}}),n.Region=function(e){if(this.options=e||{},t.extend(this,e),!this.el){var i=new Error("An 'el' must be specified");throw i.name="NoElError",i}},t.extend(n.Region.prototype,e.Events,{show:function(e,t){this.ensureEl(),this.close(),this.open(e,t),this.currentView=e},ensureEl:function(){this.$el&&0!=this.$el.length||(this.$el=this.getEl(this.el))},getEl:function(e){return i(e)},open:function(e,t){var n=this;t=t||"html",i.when(e.render()).then(function(){n.$el[t](e.el),e.onShow&&e.onShow(),e.trigger("show"),n.trigger("view:show",e)})},close:function(){var e=this.currentView;e&&(e.close&&e.close(),this.trigger("view:closed",e),delete this.currentView)},attachView:function(e){this.currentView=e}}),n.Layout=n.ItemView.extend({constructor:function(){this.vent=new e.Marionette.EventAggregator,e.Marionette.ItemView.apply(this,arguments),this.regionManagers={}},render:function(){return this.initializeRegions(),e.Marionette.ItemView.prototype.render.call(this,arguments)},close:function(){this.closeRegions(),e.Marionette.ItemView.prototype.close.call(this,arguments)},initializeRegions:function(){var i=this;t.each(this.regions,function(t,n){var r=new e.Marionette.Region({el:t,getEl:function(e){return i.$(e)}});i.regionManagers[n]=r,i[n]=r})},closeRegions:function(){var e=this;t.each(this.regionManagers,function(t,i){t.close(),delete e[i]}),this.regionManagers={}}}),n.AppRouter=e.Router.extend({constructor:function(t){if(e.Router.prototype.constructor.call(this,t),this.appRoutes){var i=this.controller;t&&t.controller&&(i=t.controller),this.processAppRoutes(i,this.appRoutes)}},processAppRoutes:function(e,i){var n,r,o,s,l=[],h=this;for(o in i)l.unshift([o,i[o]]);s=l.length;for(var c=0;s>c;c++)o=l[c][0],r=l[c][1],n=t.bind(e[r],e),h.route(o,r,n)}}),n.Application=function(e){this.initCallbacks=new n.Callbacks,this.vent=new n.EventAggregator,t.extend(this,e)},t.extend(n.Application.prototype,e.Events,{addInitializer:function(e){this.initCallbacks.add(e)},start:function(e){this.trigger("initialize:before",e),this.initCallbacks.run(this,e),this.trigger("initialize:after",e),this.trigger("start",e)},addRegions:function(e){var t,i;for(var r in e)e.hasOwnProperty(r)&&(t=e[r],i="string"==typeof t?new n.Region({el:t}):new t,this[r]=i)}}),n.BindTo={bindTo:function(e,t,i,n){n=n||this,e.on(t,i,n),this.bindings||(this.bindings=[]),this.bindings.push({obj:e,eventName:t,callback:i,context:n})},unbindAll:function(){t.each(this.bindings,function(e){e.obj.off(e.eventName,e.callback)}),this.bindings=[]}},n.Callbacks=function(){this.deferred=i.Deferred(),this.promise=this.deferred.promise()},t.extend(n.Callbacks.prototype,{add:function(e){this.promise.done(function(t,i){e.call(t,i)})},run:function(e,t){this.deferred.resolve(e,t)}}),n.EventAggregator=function(e){t.extend(this,e)},t.extend(n.EventAggregator.prototype,e.Events,n.BindTo,{bindTo:function(e,t,i){n.BindTo.bindTo.call(this,this,e,t,i)}}),n.TemplateCache={templates:{},loaders:{},get:function(e){var t=this,n=i.Deferred(),r=this.templates[e];if(r)n.resolve(r);else{var o=this.loaders[e];o?n=o:(this.loaders[e]=n,this.loadTemplate(e,function(i){delete t.loaders[e],t.templates[e]=i,n.resolve(i)}))}return n.promise()},loadTemplate:function(e,t){var n=i(e).html();t.call(this,n)},clear:function(){var e=arguments.length;if(e>0)for(var t=0;e>t;t++)delete this.templates[arguments[t]];else this.templates={}}},n.Renderer={render:function(e,t){var r=this,o=i.Deferred(),s=n.TemplateCache.get(e);return i.when(s).then(function(e){var i=r.renderTemplate(e,t);o.resolve(i)}),o.promise()},renderTemplate:function(e,i){if(!e||0===e.length){var n="A template must be specified",r=new Error(n);throw r.name="NoTemplateError",r}var o=t.template(e,i);return o}};var r=Array.prototype.slice,o=n.View.extend;return n.Region.extend=o,n.Application.extend=o,t.extend(n.View.prototype,n.BindTo),t.extend(n.Application.prototype,n.BindTo),t.extend(n.Region.prototype,n.BindTo),n}(Backbone,_,window.jQuery||window.Zepto||window.ender);