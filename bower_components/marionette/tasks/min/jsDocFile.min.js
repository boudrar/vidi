"use strict";function JsDocFilesTask(e){this.grunt=e,this.markdown=new marked.Renderer,this.dox=dox.setMarkedOptions({renderer:this.markdown,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!1,smartLists:!0,smartypants:!1,highlight:function(e,i){return highlight.highlight(i,e).value}})}var dox=require("dox"),_=require("underscore"),yaml=require("js-yaml"),marked=require("marked"),highlight=require("highlight.js");_.extend(JsDocFilesTask.prototype,{buildFiles:function(e){e.forEach(function(e){e.src.filter(function(e){return this.grunt.file.exists(e)&&!this.grunt.file.isDir(e)}.bind(this)).map(function(i){return this.compileJsDoc(e,i)}.bind(this))}.bind(this))},compileJsDoc:function(e,i){var t=this.grunt.file.read(i),r=this.parseYaml(t);r.functions=this.buildFunctions(r.functions),r.properties=this.buildProperties(r.properties),r.examples=this.buildExamples(r.examples),r.description=this.parseDescription(r.description),r.constructor=r.constructor||"",r.constructor=this.parseBody(r.constructor,"constructor"),this.writeJSON(e,r)},parseDescription:function(e){return e=e||"",marked(e)},buildFunctions:function(e){return e=e||[],_.each(e,function(i,t){e[t]=this.parseBody(i,t)},this),e},buildProperties:function(e){return e=e||[],_.each(e,function(i,t){e[t]=this.parseBody(i,t)},this),e},buildExamples:function(e){return e=e||[],_.each(e,function(i,t){e[t]=this.parseExample(i)},this),e},parseBody:function(e,i){var t={};return _.isEmpty(e)?t:(_.isObject(e)?t=e:(t.examples=[],t.description=e),t.description=this.parseDox(t.description,i),_.each(t.examples,function(e){t.examples[i]=this.parseExample(e)},this),t)},parseExample:function(e){return e.name||this.grunt.fail.fatal("jsDocFile failed to find example name"),e.example||this.grunt.fail.fatal("jsDocFile failed to find example for "+e.name),e.example=marked(e.example),e},parseDox:function(e,i){try{var t=dox.parseComment(e)}catch(r){this.grunt.fail.fatal("jsDocFile failed to parse dox at "+i)}var s=t.tags||[];return t.api=_.findWhere(s,{type:"api"}),t.params=_.where(s,{type:"param"}),t.paramStr=_.pluck(t.params,"name").join(", "),t.params=_.map(t.params,function(e){return _.extend(e,{typeStr:e.types.join(", "),description:e.description.replace(/^- /,"")})}),t},writeJSON:function(e,i){var t=JSON.stringify(i,void 0,2);this.grunt.file.write(e.dest,t)},parseYaml:function(e){try{return yaml.safeLoad(e)}catch(i){this.grunt.fail.fatal(i.name+":\n"+i.reason+"\n\n"+i.mark)}}}),module.exports=function(e){e.registerMultiTask("jsDocFiles","Compile jsdoc files to json",function(){var i=new JsDocFilesTask(e);i.buildFiles(this.files)})};