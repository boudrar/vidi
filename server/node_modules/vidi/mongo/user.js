var mongoose = require('mongoose'),
	mongoose_model = require('./model'),
	crypto = require('../crypto');


exports.login = function(user,socket){
	exports.checkUser(user,socket);
}

exports.signup = function(user,socket){
	exports.createUser(user,socket);
}


exports.createUser = function(User,socket){
	mongoose_model.user.findOne({username:User.username}, function (err, user) {
  		if (err) { console.log(err); }

  		//IF USERNAME UNKNOWN
	  	if(user==undefined){

	  		//CREATE USER
			var user = new mongoose_model.user({ 
				username : User.username,
				password:crypto.encrypt(User.password),
				video:{
					liked:0,
					shared:0,
					comments:0
				}
			});

			//SAVE USER
			user.save(function (err) {
			  if (err) { 
			  	exports.createUser.fail(socket,'Server fail :(');
			  	console.log(err); 
			  }
			  console.log(user.username + ' ajouté avec succès !');
			  exports.createUser.success(socket,'Sign Up :)',user);
			});

		}else exports.createUser.fail(socket,'Username already used');
	});
}
exports.createUser.fail = function(socket,alert){
	console.log('createUser fail');
	socket.emit('form-alert',alert,'error');
}
exports.createUser.success = function(socket,alert,user){
	console.log('createUser success');
	socket.user = user;
	socket.emit('form-alert',alert,'success',user);
}


exports.checkUser = function(User,socket){
	mongoose_model.user.findOne({username:User.username}, function (err, user) {
	  if (err) { console.log(err); }

	  if(user!=undefined){

	  	if(crypto.decrypt(user.password) == User.password)
	  		exports.checkUser.success(socket,'Success !',user);
		else exports.checkUser.fail(socket,'wrong password');

	  }else exports.checkUser.fail(socket,'wrong username & password');

	});
}
exports.checkUser.fail = function(socket,alert){
	console.log('check fail');
	socket.emit('form-alert',alert,'error');
}
exports.checkUser.success = function(socket,alert,user){
	console.log('check success');
	socket.user = user;
	socket.emit('form-alert',alert,'success',user);
}

