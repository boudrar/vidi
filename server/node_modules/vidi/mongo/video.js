var mongoose = require('mongoose'),
		model = require('./model'),
		fs = require('fs'),
		formidable = require('formidable'),
		chalk = require('chalk'),
		videoError = chalk.bold.red,
		videoSuccess = chalk.bold.green,
		_v = exports;

_v.dir = '/data/';


_v.checkUserVideos = function(id,socket){
	var query = model.video.find({userId:id}).sort('-date');

	var callback = function(err,videos){
		if(err) console.log(videoError('get-videos error',err));
		socket.emit('get-user-videos',videos);
	};

	query.exec(function(err,videos){ callback(err,videos) });
}

_v.upload = function(req,res,_dir,socket){

	var uid = req.query.uid,
			sid = req.query.sid,
			form = new formidable.IncomingForm(),
			upload_refresh = 100; //ms

	//FILE PROGRESS
	_v.upload.progress(0,socket);//init upload socket
	var now = Date.now();
	form.addListener('progress', function(bytesReceived, bytesExpected){

    var ratio = Math.round((bytesReceived/bytesExpected)*100),
    		d = (Date.now() - now);

    if(d>upload_refresh){
    	now = Date.now();
    	_v.upload.progress(ratio,socket);
    }

  });

	//FILE RECEIVE
  form.dir = _dir + _v.dir;
  form.on('file', function(field, file) {
  	_v.upload.done(file,form,uid,socket);
  });
	form.parse(req, function(err, fields, files) {
    res.writeHead(200);
    res.end();
  });

}

_v.upload.fail = function(socket,msg,user){

}

_v.upload.success = function(socket,msg,user,video){
	socket.emit('upload-success',msg,user,video);
}

_v.upload.progress = function(ratio,socket){
  socket.emit('upload-progress',ratio);
}

_v.upload.done = function(file,form,uid,socket){

	_v.upload.progress(100,socket);//upload finish

	//http://stackoverflow.com/questions/4568689/how-do-i-move-file-a-to-a-different-partition-or-device-in-node-js
	var is = fs.createReadStream(file.path);
	var os = fs.createWriteStream(form.dir + file.name);

	is.pipe(os);
	is.on('end',function() {
	    fs.unlinkSync(file.path);
	});
	//fs.rename(file.path, form.dir + file.name);

  var video = new model.video({
		userId: uid,
		source : 'server' + _v.dir + file.name,
		title : file.name
	});

	video.save(function (err) {

	  if (err) { 
	  	_v.upload.fail(socket,'Server upload fail :(');
	  	console.log(videoError(err)); 
	  }
	 
	  model.user.findOne({_id:uid},function(err,user){
	  	if(err)console.log('user shared inc error',err);
	  	user.video.shared++;
	  	var User=user;
	  	user.save();
	  	_v.upload.success(socket,'Server upload success :)',User,video);
	  });

	  console.log(videoSuccess(video.title + ' ajouté avec succès !'));

	});
}