var mongoose = require('mongoose'),
		model = require('./model'),
		fs = require('fs'),
		formidable = require('formidable'),
		_v = exports;

_v.dir = '/data/';


_v.check = function(id,socket){
	model.video.find({userId:id},function(err,videos){
		if(err)console.log('get-videos error',err);
		socket.emit('get-user-videos',videos);
	});
}

_v.upload = function(req,res,_dir,socket){

	var uid = req.query.uid,
			sid = req.query.sid,
			form = new formidable.IncomingForm(),
			upload_refresh = 100;

	console.log(uid,sid,socket.id);

	//FILE PROGRESS
	_v.upload.progress(0,socket);//init upload socket
	var now = Date.now();
	form.addListener('progress', function(bytesReceived, bytesExpected){

    var ratio = Math.round((bytesReceived/bytesExpected)*100),
    		d = (Date.now() - now);
    if(d>upload_refresh){
    	now = Date.now();
    	_v.upload.progress(ratio,socket);
    }

  });

	//FILE RECEIVE
  form.dir = _dir + _v.dir;
  form.on('file', function(field, file) {
  	_v.upload.done(file,form,uid,socket);
  });
	form.parse(req, function(err, fields, files) {
    res.writeHead(200);
    res.end();
  });

}

_v.upload.fail = function(socket,msg,user){

}

_v.upload.success = function(socket,msg,user){
	socket.emit('update-profil',msg,user);
}

_v.upload.progress = function(ratio,socket){
  socket.emit('upload-progress',ratio);
}

_v.upload.done = function(file,form,uid,socket){

	_v.upload.progress(100,socket);//upload finish

  fs.rename(file.path, form.dir + "/" + file.name);

  var video = new model.video({
		userId: uid,
		source : form.dir + "/" + file.name,
		title : file.name,
		desc : '',
	  comments : [],
	});

	video.save(function (err) {

	  if (err) { 
	  	_v.upload.fail(socket,'Server upload fail :(');
	  	console.log(err); 
	  }
	 
	  model.user.findOne({_id:uid},function(err,user){
	  	if(err)console.log('user shared inc error',err);
	  	user.video.shared++;
	  	var User=user;
	  	user.save();
	  	_v.upload.success(socket,'Server upload success :)',User);
	  });

	  console.log(video.title + ' ajouté avec succès !');
	  _v.check(uid,socket);

	});
}