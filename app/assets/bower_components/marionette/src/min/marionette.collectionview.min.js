Marionette.CollectionView=Marionette.View.extend({childViewEventPrefix:"childview",constructor:function(i){var e=i||{};this.sort=_.isUndefined(e.sort)?!0:e.sort,this.once("render",this._initialEvents),this._initChildViewStorage(),Marionette.View.apply(this,arguments),this.initRenderBuffer()},initRenderBuffer:function(){this.elBuffer=document.createDocumentFragment(),this._bufferedChildren=[]},startBuffering:function(){this.initRenderBuffer(),this.isBuffering=!0},endBuffering:function(){this.isBuffering=!1,this._triggerBeforeShowBufferedChildren(),this.attachBuffer(this,this.elBuffer),this._triggerShowBufferedChildren(),this.initRenderBuffer()},_triggerBeforeShowBufferedChildren:function(){this._isShown&&_.each(this._bufferedChildren,_.partial(this._triggerMethodOnChild,"before:show"))},_triggerShowBufferedChildren:function(){this._isShown&&(_.each(this._bufferedChildren,_.partial(this._triggerMethodOnChild,"show")),this._bufferedChildren=[])},_triggerMethodOnChild:function(i,e){Marionette.triggerMethodOn(e,i)},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"add",this._onCollectionAdd),this.listenTo(this.collection,"remove",this._onCollectionRemove),this.listenTo(this.collection,"reset",this.render),this.sort&&this.listenTo(this.collection,"sort",this._sortViews))},_onCollectionAdd:function(i){this.destroyEmptyView();var e=this.getChildView(i),t=this.collection.indexOf(i);this.addChild(i,e,t)},_onCollectionRemove:function(i){var e=this.children.findByModel(i);this.removeChildView(e),this.checkEmpty()},onShowCalled:function(){this.children.each(_.partial(this._triggerMethodOnChild,"show"))},render:function(){return this._ensureViewIsIntact(),this.triggerMethod("before:render",this),this._renderChildren(),this.triggerMethod("render",this),this},resortView:function(){this.render()},_sortViews:function(){var i=this.collection.find(function(i,e){var t=this.children.findByModel(i);return!t||t._index!==e},this);i&&this.resortView()},_renderChildren:function(){this.destroyEmptyView(),this.destroyChildren(),this.isEmpty(this.collection)?this.showEmptyView():(this.triggerMethod("before:render:collection",this),this.startBuffering(),this.showCollection(),this.endBuffering(),this.triggerMethod("render:collection",this))},showCollection:function(){var i;this.collection.each(function(e,t){i=this.getChildView(e),this.addChild(e,i,t)},this)},showEmptyView:function(){var i=this.getEmptyView();if(i&&!this._showingEmptyView){this.triggerMethod("before:render:empty"),this._showingEmptyView=!0;var e=new Backbone.Model;this.addEmptyView(e,i),this.triggerMethod("render:empty")}},destroyEmptyView:function(){this._showingEmptyView&&(this.triggerMethod("before:remove:empty"),this.destroyChildren(),delete this._showingEmptyView,this.triggerMethod("remove:empty"))},getEmptyView:function(){return this.getOption("emptyView")},addEmptyView:function(i,e){var t=this.getOption("emptyViewOptions")||this.getOption("childViewOptions");_.isFunction(t)&&(t=t.call(this));var n=this.buildChildView(i,e,t);this.proxyChildEvents(n),this._isShown&&Marionette.triggerMethodOn(n,"before:show"),this.children.add(n),this.renderChildView(n,-1),this._isShown&&Marionette.triggerMethodOn(n,"show")},getChildView:function(){var i=this.getOption("childView");if(!i)throw new Marionette.Error({name:"NoChildViewError",message:'A "childView" must be specified'});return i},addChild:function(i,e,t){var n=this.getOption("childViewOptions");_.isFunction(n)&&(n=n.call(this,i,t));var r=this.buildChildView(i,e,n);return this._updateIndices(r,!0,t),this._addChildView(r,t),r},_updateIndices:function(i,e,t){this.sort&&(e?(i._index=t,this.children.each(function(e){e._index>=i._index&&e._index++})):this.children.each(function(e){e._index>=i._index&&e._index--}))},_addChildView:function(i,e){this.proxyChildEvents(i),this.triggerMethod("before:add:child",i),this.children.add(i),this.renderChildView(i,e),this._isShown&&!this.isBuffering&&Marionette.triggerMethodOn(i,"show"),this.triggerMethod("add:child",i)},renderChildView:function(i,e){return i.render(),this.attachHtml(this,i,e),i},buildChildView:function(i,e,t){var n=_.extend({model:i},t);return new e(n)},removeChildView:function(i){return i&&(this.triggerMethod("before:remove:child",i),i.destroy?i.destroy():i.remove&&i.remove(),this.stopListening(i),this.children.remove(i),this.triggerMethod("remove:child",i),this._updateIndices(i,!1)),i},isEmpty:function(){return!this.collection||0===this.collection.length},checkEmpty:function(){this.isEmpty(this.collection)&&this.showEmptyView()},attachBuffer:function(i,e){i.$el.append(e)},attachHtml:function(i,e,t){i.isBuffering?(i.elBuffer.appendChild(e.el),i._bufferedChildren.push(e)):i._insertBefore(e,t)||i._insertAfter(e)},_insertBefore:function(i,e){var t,n=this.sort&&e<this.children.length-1;return n&&(t=this.children.find(function(i){return i._index===e+1})),t?(t.$el.before(i.el),!0):!1},_insertAfter:function(i){this.$el.append(i.el)},_initChildViewStorage:function(){this.children=new Backbone.ChildViewContainer},destroy:function(){return this.isDestroyed?void 0:(this.triggerMethod("before:destroy:collection"),this.destroyChildren(),this.triggerMethod("destroy:collection"),Marionette.View.prototype.destroy.apply(this,arguments))},destroyChildren:function(){var i=this.children.map(_.identity);return this.children.each(this.removeChildView,this),this.checkEmpty(),i},proxyChildEvents:function(i){var e=this.getOption("childViewEventPrefix");this.listenTo(i,"all",function(){var t=slice.call(arguments),n=t[0],r=this.normalizeMethods(_.result(this,"childEvents"));t[0]=e+":"+n,t.splice(1,0,i),"undefined"!=typeof r&&_.isFunction(r[n])&&r[n].apply(this,t.slice(1)),this.triggerMethod.apply(this,t)},this)}});